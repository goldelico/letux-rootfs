#
# Copyright Golden Delicious Computers GmbH&Co. KG, 2010-2016
# licenced unter GPL 2.0
#
# this is part of OM Beagle Hybrid / GTA04
# it is derived from http://elinux.org/BeagleBoardDebian
#
# run this script to install/update the packages by some useful tools
#

apt-get update	# get latest package list
yes | dpkg --configure -a	# try to cleanup if previous attempt failed
apt-get install -y --force-yes debian-archive-keyring
apt-get update		# get latest package list again
apt-get install -y apt-utils

# fix issue with locale

#
# install useful command line tools (some may be already there by debootstrap)
#

USEFUL="ntp"	# update clock from network
USEFUL+=" locales"		# or we get tons of error messages
USEFUL+=" sudo"			# always nice to have...
USEFUL+=" file"			# same
USEFUL+=" bzip2"		# needed for tar xjf 
USEFUL+=" udev"			# very important
USEFUL+=" dnsutils"     # nslookup etc.
USEFUL+=" cpufrequtils" # check/modify CPU frequency
USEFUL+=" mtd-utils"    # read/write/erase NAND
USEFUL+=" i2c-tools"    # read/write/scan I2C
USEFUL+=" alsa-utils"   # alsamixer, aplay etc.
USEFUL+=" fbset"       # to switch to TV-Out
USEFUL+=" usbmount usbutils eject"
USEFUL+=" evtest"       # allows to check touch screen, keyboard and button events
USEFUL+=" openssh-server openssh-client"    # remote access thorugh ssh
USEFUL+=" libertas-firmware wireless-tools" # driver for Marvell WLAN (GTA04)
USEFUL+=" firmware-ti-connectivity"	# driver for TiWi WLAN (Pandaboard, Pyra)
USEFUL+=" wpasupplicant"       # if we want to setup a protected network
USEFUL+=" rfkill"
USEFUL+=" fbcat"
USEFUL+=" dosfstools parted"	# to make bootable SD cards
USEFUL+=" autofs"		# automount USB drives (BB, GTA04 in OTG mode), memory cards (Pyra), external hard drives (OMAP5 eSATA)
USEFUL+=" man-db"		# some tools install a manual anyways - so why not make them readable
USEFUL+=" iptables"		# for WWAN <-> USB <-> WLAN tethering
USEFUL+=" libc6-dev linux-libc-dev gcc make"		# so that we can cc some (simple) binaries from source (big!)
USEFUL+=" devmem2"	# for poking around in SoC registers
USEFUL+=" isc-dhcp-client"

# package name changes between versions

case "$(cat /etc/debian_version)" in
	7.* )
		USEFUL+=" dhcpcd"		# so that we can get an IP address from the access point
		USEFUL+=" uboot-envtools"	# read write U-Boot environment e.g. to trigger boot to boot-menu or reflash
		USEFUL+=" bluez-utils bluez-audio"          # driver for HCI Bluetooth (big! installs python)
		USEFUL+=" isc-dhcp-server"	# for WWAN <-> USB <-> WLAN tethering
		USEFUL+=" mediactl"	# for omap3 camera isp control
		;;
	8.* | 9.* )
# breaks /etc/resolv.conf	USEFUL+=" dhcpcd5"		# so that we can get an IP address from the access point
		USEFUL+=" u-boot-tools"	# read write U-Boot environment e.g. to trigger boot to boot-menu or reflash
		USEFUL+=" bluez-tools bluez"          # driver for HCI Bluetooth
		USEFUL+=" iw"          # iw (replacement for iwconfig)
		USEFUL+=" v4l-utils"	# for omap3 camera isp control
		;;
esac

if true
# install all in once
then
	yes | apt-get install -y --force-yes --no-install-recommends $USEFUL
# install one after the other to identify dependencies
else
	for U in $USEFUL
		do yes | apt-get -y --force-yes --no-install-recommends install $U
	done
fi

/usr/sbin/locale-gen en_US en_US.UTF-8

#
# install X11 driver for omap3
#

yes | apt-get install -y --force-yes --no-install-recommends xorg

case "$(cat /etc/debian_version)" in

5.* )	# Lenny needs a backport
	#
	# backport touch screen driver to fix http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=493942
	# see (German): http://wiki.unixboard.de/index.php/Debian_Backports
	#

	wget -c http://rcn-ee.homeip.net:81/dl/deb-sbuild/lenny/xorg-drivers/xserver-xorg-video-omap3_0.1.1-2_armel.deb
	dpkg -i xserver-xorg-video-omap3_0.1.1-2_armel.deb

	yes | apt-get install -y build-essential dpkg-dev debhelper xserver-xorg-dev libts-dev pkg-config

	wget http://ftp.debian.org/debian/pool/main/x/xf86-input-tslib/xf86-input-tslib_0.0.4-5.dsc
	wget http://ftp.debian.org/debian/pool/main/x/xf86-input-tslib/xf86-input-tslib_0.0.4-5.diff.gz
	wget http://ftp.debian.org/debian/pool/main/x/xf86-input-tslib/xf86-input-tslib_0.0.4.orig.tar.gz
	dpkg-source -x xf86-input-tslib_0.0.4-5.dsc
	( 
	cd xf86-input-tslib-0.0.4
	dpkg-checkbuilddeps
	### apply our patch ###
	cp ../tslib.c src/tslib.c
	dpkg-buildpackage
	)

	# note: removing dpkg-dev will also remove usb-modeswitch !?!

	apt-get remove -y build-essential debhelper xserver-xorg-dev libts-dev pkg-config
	rm -rf xf86-input-tslib_0.0.4* xf86-input-tslib-0.0.4
	dpkg -i xserver-xorg-input-tslib_0.0.4-5_armel.deb

	yes | apt-get install -y --force-yes libts-bin

	;;
6.* )	# Squeeze x-server and touch screen support

	yes | apt-get install -y xserver-xorg-video-omap3 xserver-xorg-input-tslib xserver-xorg-input-void libts-bin

	# Kernels newer than 2.6.37 use a different EV_VERSION

	case "$(uname -r)" in
	2.6.37 | 2.6.38 | 2.6.39 | 3.* )
		wget http://download.goldelico.com/gta04/debian/dists/stable/main/binary-armel/libts-0.0-0_1.0-8lindi1_armel.deb
		dpkg -i libts-0.0-0_1.0-8lindi1_armel.deb
		;;
	esac

	;;
7.* )	# Wheezy x-server and touch screen support

	yes | apt-get install -y --force-yes --no-install-recommends xserver-xorg-video-omap3 xserver-xorg-input-void

	# there is no xserver-xorg-input-tslib in wheezy!
	# yes | apt-get install  -y --force-yes-y libts-bin

# makes X11 crash :(
#	wget http://ftp.de.debian.org/debian/pool/main/x/xf86-input-tslib/xserver-xorg-input-tslib_0.0.6-7+b1_armhf.deb
#	dpkg -i xserver-xorg-input-tslib_0.0.6-7+b1_armhf.deb

	wget http://launchpadlibrarian.net/86564073/xinput-calibrator_0.7.5-0ubuntu1_armhf.deb
	dpkg -i xinput-calibrator_0.7.5-0ubuntu1_armhf.deb && rm xinput-calibrator_0.7.5-0ubuntu1_armhf.deb
	;;

8.* )	# Jessie x-server and touch screen support
	yes | apt-get install -y --force-yes --no-install-recommends xserver-xorg-video-omap xserver-xorg-input-void xserver-xorg-video-fbdev- lightdm- xinput-calibrator
	;;

* )
	echo "unknown Debian Version: $(cat /etc/debian_version)"
	;;
esac

#
# install GUI components
#

# apt-get install -y gnome-core gdm
# apt-get install -y kde-core kdm
# apt-get install -y gdm
# apt-get install -y xfce4
# apt-get install -y matchbox
# apt-get install -y quantumstep quantumstep-displaymanager

# yes | apt-get install -y --force-yes --no-install-recommends -y lxde lxlauncher lxtask lxmusic
# yes | apt-get remove -y --force-yes network-manager lightdm	# makes interferences if installed

#
# applications, tools and games
#

USEFUL="gpsd"
USEFUL+=" foxtrotgps"
USEFUL+=" dbus-x11"
# USEFUL+=" synaptic"
USEFUL+=" matchbox-keyboard matchbox-keyboard-im"

if true
# install all in once
then
	yes | apt-get install --no-install-recommends $USEFUL
# install one after the other to identify dependencies
else
	for U in $USEFUL
		do yes | apt-get install $U
	done
fi

#
# cleanup
#

apt-get -y autoremove
apt-get -y autoclean
apt-get -y clean
rm -f *.deb

#
# reinstall our private configuration (apt-get install may have overwritten some parts)
#

(cd / && tar xvzf /root/config.tgz)

echo useful packages installed and configured.
