#! /bin/bash
#
# configure Linux or macOS host for tethering with an Letux device connected through ethernet over USB (RNDIS/NCM ethernet gadget)
#
# it uses the current service or default route for internet connection
#
# on Mac the device is identified by its IP address
# on Linux the device is (currently) assumed to create ifconfig usb0
#
# on Mac it is possible to install a Launch Daemon to activate on reboot
#

DEVICE=192.168.0.202	# Letux device

case "$0" in
	/* )
		SCRIPTPATH="$0"
		;;
	./* )
		SCRIPTPATH="$PWD/$0"
		;;
	* )	# should search in $PATH
		echo "can't install $0";
		exit 1
		;;
esac

echo "+++ running $SCRIPTPATH"
date

install_launch_daemon() {
SERVERADMIN=/Applications/Server.app/Contents/ServerRoot/usr/sbin/serveradmin
UUID=com.goldelico.ajzaurus
LAUNCHDAEMON=/Library/LaunchDaemons/$UUID.plist

if [ ! -r "$LAUNCHDAEMON" -o "$SCRIPTPATH" -nt "$LAUNCHDAEMON" ]
then
	echo "+++ install $LAUNCHDAEMON for $SCRIPTPATH"
	sudo launchctl stop $UUID || echo "$UUID may not be installed (can be ignored)."
	sudo launchctl unload $LAUNCHDAEMON || echo "$UUID may not be installed (can be ignored)."

	cat <<END | sudo tee $LAUNCHDAEMON >/dev/null
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>Label</key>
	<string>$UUID</string>
	<key>LowPriorityIO</key>
	<true/>
	<key>ProgramArguments</key>
	<array>
		<string>$SCRIPTPATH</string>
	</array>
	<key>StandardErrorPath</key>
	<string>/tmp/$UUID.stderr</string>
	<key>StandardOutPath</key>
	<string>/tmp/$UUID.stdout</string>
	<key>WatchPaths</key>
	<array>
		<string>/etc/resolv.conf</string>
		<string>/var/run/resolv.conf</string>
		<string>/private/var/run/resolv.conf</string>
	</array>
	<key>RunAtLoad</key>
	<true/>
	<key>StartCalendarInterval</key>
	<dict>
		<key>Hour</key>
		<integer>3</integer>
		<key>Minute</key>
		<integer>47</integer>
	</dict>
	<key>Description</key>
	<string>Update ip-forwarding on network changes, once per day and at boot</string>
</dict>
</plist>
END
	sudo launchctl load $LAUNCHDAEMON
	# will trigger a first update
	sudo launchctl start $UUID
	echo "+++ installed"
fi
}

darwin() {
# based on
# http://apple.stackexchange.com/questions/228936/using-server-5-0-15-to-share-internet-without-internet-sharing
# https://superuser.com/questions/931827/sharing-openvpn-on-mac-os-x-yosemite

# locate highest priority active service
# found at https://apple.stackexchange.com/questions/191879/how-to-find-the-currently-connected-network-service-from-the-command-line
# and improved...
# active VPN (utun) hides highest priority active network so we check first

CURRENT=""
INTERFACE=""

while read LINE
do
	NAME=$(echo $LINE | awk -F  "(, )|(: )|[)]" '{print $2}')
	DEV=$(echo $LINE | awk -F  "(, )|(: )|[)]" '{print $4}')
# echo "Current service: $NAME, $DEV, $CURRENT, $INTERFACE"
	if [ "$DEV" ]
	then
		case "$NAME" in utun* )
			if ifconfig "$DEV" 2>/dev/null | grep -q 'status: active'
			then
				CURRENT="$NAME"
				INTERFACE="$DEV"
				break 2	# take first we find
			fi
		esac
	fi
done < <(networksetup -listnetworkserviceorder | grep 'Hardware Port')

echo "$INTERFACE"

if [ ! "$INTERFACE" ]	# no VPN found
then

	while read LINE
	do
		NAME=$(echo $LINE | awk -F  "(, )|(: )|[)]" '{print $2}')
		DEV=$(echo $LINE | awk -F  "(, )|(: )|[)]" '{print $4}')
# echo "Current service: $NAME, $DEV, $CURRENT, $INTERFACE"
		if [ "$DEV" ]
		then
			if ifconfig "$DEV" 2>/dev/null | grep -q 'status: active'
			then
				CURRENT="$NAME"
				INTERFACE="$DEV"
# echo "found: $NAME, $DEV, $CURRENT, $INTERFACE"
				break 2	# take first we find
			fi
		fi
	done < <(networksetup -listnetworkserviceorder | grep 'Hardware Port')

fi

# echo "found: $NAME, $DEV, $CURRENT, $INTERFACE"

if [ ! "$CURRENT" ]
then
	echo "Could not identify current internet service on your host" >&2
	exit 1
fi
echo Sharing $DEVICE over: $CURRENT $INTERFACE

echo "(NOTE: ignore messages about ALTQ)"
sudo pfctl -F nat

echo "nat log on $INTERFACE from $DEVICE to any -> ($INTERFACE)"
#nat log on en0 from $DEVICE to any -> (en0)" | sudo pfctl -N -f - -e
echo "(NOTE: ignore messages about -f option flushing rules)"
echo "nat log on $INTERFACE from $DEVICE to any -> ($INTERFACE)" | sudo pfctl -N -f - -e
sudo pfctl -a '*' -s nat

echo "sysctl (one of these should succeed)"	# FIXME: we could make this depend on $(uname -r)
sudo sysctl -w net.inet.ip.forwarding=1
sudo sysctl -w net.inet.ip.fw.enable=1 || echo "may fail on newer macOS kernels (can be ignored)."
# sudo sysctl -w net.inet6.ip6.forwarding=1

## logging
# ifconfig pflog1 create
# sudo tcpdump -n -e -ttt -i pflog1
# sudo tcpdump -n -e -ttt -i $INTERFACE

install_launch_daemon
}

linux() {
# based on http://jpdelacroix.com/tutorials/sharing-internet-beaglebone-black.html

HOST=192.168.0.200	# fixme: somehow find out or calculate...
USB=usb0	# fixme - find out where the Letux device is connected to
INTERFACE=$(route | grep '^default' | head -1 | grep -o '[^ ]*$')	# first default route

if [ ! "$INTERFACE" ]
then
	echo "Could not find current internet service interface" >&2
	exit 1
fi

echo Sharing $DEVICE at $USB over: $INTERFACE

ifconfig $USB $HOST
sysctl net.ipv4.ip_forward=1
iptables --table nat --append POSTROUTING --out-interface $INTERFACE -j MASQUERADE
iptables --append FORWARD --in-interface $USB -j ACCEPT
}

case "$(uname -s)" in
Darwin )
	darwin;;
Linux )
	linux;;
* )
	echo unknown operating system $(uname -a)
	;;
esac
